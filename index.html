<!doctype html>
<meta charset="utf8">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
  integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
  crossorigin=""/>
<style>
html, body, #map { margin: 0; height: 100% }
</style>
<body>
<div id="map"></div>
<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
  integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
  crossorigin=""></script>
<script src="https://unpkg.com/topojson@3"></script>
<script src="https://unpkg.com/d3@3"></script>
<script>

function rendermap(geojson, table) {
  var colorMap = {
    'closed': 'red',
    'restricted': 'orange',
    'open': 'green',
  };

  function style(feature) {
      return {
          fillColor: feature.properties.color,
          weight: 1,
          opacity: 1,
          color: 'white',
          //dashArray: '3',
          fillOpacity: 0.7
      };
  }

  var map = L.map('map');

  var countries = {
    type: "FeatureCollection",
    features: []
  };
  geojson.features.map((feature) => {
    var props = feature.properties;
    var code = props.WB_A2;
    var color = 'lightgrey';
    if(table[code]) {
      var row = table[code]
      var status = row.status;
      color = colorMap[status] || 'grey';
      props.popupText = '<h1>'+row.name+'</h1><p>'+row.description+'</p>'
    }
    props.color = color;
    countries.features.push(feature);
  });

  var geoJsonLayer = L.geoJson(countries, {
    style: style,
    onEachFeature: (feature, layer) => {
      var props = feature.properties;
      if(props.popupText) {
        layer.bindPopup(props.popupText);
      }
    }
  }).addTo(map);

  map.fitBounds([[34, -28], [74, 45]]);
}

var csvUrl = './restrictii.csv';

fetch('./countries.json')
  .then((res) => res.json())
  .then((data) => {
    var geojson = topojson.feature(data, data.objects.ne_10m_admin_0_countries);
    return fetch(csvUrl)
      .then((res) => res.text())
      .then((text) => {
        var table = {}
        d3.csv.parse(text).map((row) => {
          table[row.code] = row;
        });
        rendermap(geojson, table);
      });
  })
  .catch((e) => { console.error(e); });

</script>
