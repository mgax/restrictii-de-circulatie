<!doctype html>
<meta charset="utf8">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
  integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
  crossorigin=""/>
<style>
html, body, #map { margin: 0; height: 100% }
</style>
<body>
<div id="map"></div>
<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
  integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
  crossorigin=""></script>
<script src="https://unpkg.com/topojson@3"></script>
<script src="https://unpkg.com/d3@3"></script>
<script>

function rendermap(geojson, table) {
  var colorMap = {
    'closed': 'red',
    'restricted': 'orange',
    'open': 'green',
  };

  function style(feature) {
      return {
          fillColor: feature.properties.color,
          weight: 1,
          opacity: 1,
          color: 'white',
          //dashArray: '3',
          fillOpacity: 0.7
      };
  }

  var map = L.map('map'); //.setView([51.505, -0.09], 13);

  // L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  //     attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  // }).addTo(map);



  var countries = {
    type: "FeatureCollection",
    features: []
  };
  geojson.features.map((feature) => {
    //var style = styleFor(feature);
    var props = feature.properties;
    if(props.SOV_A3==='NOR') props.WB_A2 = 'NO';
    var code = props.WB_A2;
    if(! table[code]) return;
    var status = table[code].status;
    delete table[code];
    var color = colorMap[status] || 'grey';
    props.color = color;
    countries.features.push(feature);
  });
  console.log(table);

  console.log(countries);
  var geoJsonLayer = L.geoJson(countries, {style: style}).addTo(map);

  // map.fitBounds(geoJsonLayer.getBounds());
  /// map.fitBounds([[-28, 34], [45, 74]]);
  map.fitBounds([[34, -28], [74, 45]]);

  // L.marker([51.5, -0.09]).addTo(map)
  //     .bindPopup('A pretty CSS3 popup.<br> Easily customizable.')
  //     .openPopup();
}

var csvUrl = './restrictii.csv';
// var csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQtcZMmKHmwf_YXXCoiicFOor1XhAv1wLqUdNG92rIFfC8efe_uvCqBSaN3bUlS_p_19w9d0DcRIcHM/pub?gid=0&single=true&output=csv';

fetch('./countries.json')
  .then((res) => res.json())
  .then((data) => {
    var geojson = topojson.feature(data, data.objects.ne_10m_admin_0_countries);
    return fetch(csvUrl)
      .then((res) => res.text())
      .then((text) => {
        var table = {}
        d3.csv.parse(text).map((row) => {
          table[row.code] = row;
        });
        rendermap(geojson, table);
      });
  })
  .catch((e) => { console.error(e); });

</script>
